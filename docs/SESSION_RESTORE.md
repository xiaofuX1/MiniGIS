# 会话恢复功能

## 概述

MiniGIS 提供了完整的会话恢复功能，能够自动保存和恢复应用程序的所有状态，确保用户在重启应用后可以继续之前的工作。

## 保存的状态信息

### 1. 地图状态
- **地图位置**：中心点坐标（经纬度）
- **缩放级别**：当前的地图缩放比例
- **旋转角度**：地图旋转状态（预留功能）

### 2. 图层信息
- **数据图层**：
  - 图层ID、名称、类型
  - 数据源路径或URL
  - 可见性状态
  - 透明度设置
  - 样式配置（填充色、描边色、线宽、符号系统等）
  - 标注配置（字段、字体、颜色、光晕等）
  - 图层范围（extent）
  
- **底图配置**：
  - 底图ID、名称
  - 底图URL
  - 可见性和透明度

### 3. 坐标系统
- 当前使用的坐标系代码（如 EPSG:4326）
- 坐标系名称
- 坐标系类型（地理/投影坐标系）
- WKT定义

### 4. UI 布局状态
- **面板折叠状态**：
  - 左侧面板（图层面板）
  - 右侧面板（属性/符号/标注面板）
  - 底部面板（属性表）
  
- **面板尺寸和位置**：
  - 各面板的宽度和高度
  - 面板停靠位置（左、右、底部、浮动）
  - 浮动面板的具体位置
  
- **右侧面板类型**：
  - feature（要素属性）
  - symbology（符号化）
  - label（标注）

### 5. 属性表状态
- 当前打开的属性表图层ID列表
- 当前激活的属性表标签页

## 自动保存机制

### 保存时机
应用会在以下情况自动保存状态：

1. **图层变化**：添加、删除、修改图层后 2 秒
2. **地图移动**：平移或缩放地图后 1 秒
3. **坐标系切换**：切换坐标系后 0.1 秒
4. **UI 状态变化**：面板折叠/展开、调整尺寸后 1 秒

### 延迟保存策略
为了避免频繁写入 localStorage，系统采用延迟保存策略：
- 状态变化触发保存计时器
- 如果在延迟时间内再次变化，重置计时器
- 只在用户操作停止后才执行实际保存

## 恢复流程

### 启动时恢复
应用启动后 1 秒，自动执行恢复流程：

1. **加载保存的状态**
   - 从 localStorage 读取 `minigis_last_session`

2. **恢复地图状态**
   - 设置地图中心点和缩放级别

3. **恢复坐标系**
   - 从 CRS 列表查找匹配的坐标系
   - 如果找不到预定义坐标系，使用保存的完整定义

4. **恢复 UI 布局**
   - 恢复各面板的折叠状态
   - 恢复面板尺寸和位置
   - 恢复右侧面板类型

5. **恢复底图**
   - 移除默认底图
   - 添加用户保存的底图配置

6. **恢复数据图层**
   - 验证图层文件是否存在
   - 重新加载 GeoJSON 数据
   - 应用保存的样式和标注配置

7. **恢复属性表**
   - 打开之前打开的属性表
   - 切换到之前激活的标签页

### 容错处理

- **文件不存在**：自动跳过不存在的图层文件，显示警告
- **数据损坏**：单个图层恢复失败不影响其他图层
- **坐标系缺失**：如果找不到坐标系，使用保存的完整定义
- **加载失败**：显示错误信息，但不中断应用启动

## 数据存储

### 存储位置
状态数据保存在浏览器的 localStorage 中：
- 键名：`minigis_last_session`
- 格式：JSON

### 存储大小
- 一般情况下 < 100KB
- 包含大量图层时可能达到 1-2MB
- localStorage 限制：通常 5-10MB

### 隐私和安全
- 数据仅保存在本地浏览器
- 不会上传到服务器
- 清除浏览器数据会删除保存的状态

## 手动清除

如果需要清除保存的会话：

```javascript
// 在浏览器控制台执行
localStorage.removeItem('minigis_last_session');
```

或者通过浏览器设置清除站点数据。

## 开发者信息

### 相关文件
- `src/services/storageService.ts` - 存储服务
- `src/hooks/useRestoreSession.ts` - 恢复会话 Hook
- `src/stores/layerStore.ts` - 图层状态管理
- `src/stores/mapStore.ts` - 地图状态管理
- `src/stores/crsStore.ts` - 坐标系状态管理
- `src/stores/uiStore.ts` - UI 状态管理

### 扩展功能
如需添加新的状态保存：

1. 在 `ProjectState` 接口中添加新字段
2. 在 `layerStore.saveAllState()` 中保存新数据
3. 在 `useRestoreSession` 中添加恢复逻辑
4. 在对应的 store 中添加状态变化监听

## 最佳实践

### 用户建议
- 重要工作前，建议手动保存项目文件
- 不要在浏览器隐私模式下使用（localStorage 不可用）
- 定期备份重要项目文件

### 开发建议
- 保持状态数据结构简单
- 避免保存大量冗余数据
- 添加版本号以支持状态迁移
- 充分测试容错处理逻辑

## 故障排查

### 会话未恢复
1. 检查浏览器控制台是否有错误
2. 确认 localStorage 是否可用
3. 检查是否在隐私模式下运行

### 恢复速度慢
1. 减少图层数量
2. 检查图层文件是否可访问
3. 查看网络请求（底图加载）

### 部分状态未恢复
1. 查看控制台警告信息
2. 确认文件路径是否正确
3. 检查数据格式是否兼容
