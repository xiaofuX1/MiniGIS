# 多地图标签页功能说明

## 功能概述

已成功实现类似 ArcGIS Pro 的多地图标签页功能，用户可以同时管理多个独立的地图实例，每个地图拥有独立的图层管理系统。

## 主要特性

### 1. 多地图标签页管理
- ✅ 创建多个独立的地图标签页
- ✅ 每个标签页有独立的地图视图、中心点和缩放级别
- ✅ 标签页切换时自动切换对应的地图和图层
- ✅ 支持重命名标签页
- ✅ 支持关闭标签页（至少保留一个）

### 2. 独立的图层管理
- ✅ 每个地图标签页拥有独立的图层列表
- ✅ 图层面板自动显示当前激活标签页的图层
- ✅ 切换标签页时，图层面板内容自动更新
- ✅ 图层操作（添加、删除、排序、可见性等）仅影响当前标签页

### 3. 新建地图功能
- ✅ 在 Ribbon 菜单的"插入"标签页中添加"新建地图"按钮
- ✅ 点击后自动创建新的地图标签页并切换到该标签页
- ✅ 标签页右上角也提供"新建地图"按钮

## 技术实现

### 核心文件

1. **mapTabsStore.ts** - 多地图标签页状态管理
   - 管理所有地图标签页的状态
   - 提供标签页的 CRUD 操作
   - 为每个标签页维护独立的图层、视图状态

2. **MapTabsContainer.tsx** - 标签页容器组件
   - 渲染标签页 UI
   - 处理标签页切换、创建、删除、重命名
   - 为每个标签页创建独立的 MapView 实例

3. **MapView.tsx** - 地图视图组件（已修改）
   - 支持 `tabId` 参数，可工作在多标签页模式
   - 根据 `tabId` 从 mapTabsStore 或 layerStore 获取数据
   - 自动同步地图状态到对应的标签页

4. **LayerPanel.tsx** - 图层面板（已修改）
   - 检测是否处于多标签页模式
   - 自动显示当前激活标签页的图层
   - 图层操作自动应用到当前标签页

5. **RibbonMenu.tsx** - 功能区菜单（已修改）
   - 添加"插入"标签页
   - 提供"新建地图"功能
   - 图层操作支持多标签页模式

## 使用方法

### 创建新地图
1. 点击 Ribbon 菜单的"插入"标签
2. 点击"新建地图"按钮
3. 或直接点击标签页右上角的"新建地图"按钮

### 切换地图
- 直接点击标签页即可切换到对应的地图

### 重命名地图
1. 右键点击标签页（或点击标签页上的"..."菜单）
2. 选择"重命名"
3. 输入新名称并确认

### 关闭地图
1. 点击标签页上的"×"按钮
2. 或右键点击标签页选择"关闭"
3. 注意：至少需要保留一个地图标签页

### 添加图层
- 在任何标签页中添加图层，图层只会添加到当前激活的标签页
- 切换标签页后，图层面板会自动显示对应标签页的图层

## 数据结构

每个地图标签页包含以下独立状态：
```typescript
interface MapTab {
  id: string;                           // 唯一标识
  name: string;                         // 地图名称
  center: [number, number];             // 地图中心点
  zoom: number;                         // 缩放级别
  layers: Layer[];                      // 图层列表
  selectedLayer: Layer | null;          // 当前选中的图层
  attributeTableLayerIds: string[];     // 属性表图层ID列表
  activeAttributeTableLayerId: string | null; // 激活的属性表图层
  createdAt: number;                    // 创建时间戳
}
```

## 兼容性说明

- 所有现有功能（添加数据、底图切换、属性表、符号设置等）均已适配多标签页模式
- 如果只有一个标签页，功能表现与原来一致
- 自动检测并切换单地图模式和多标签页模式

## 状态持久化功能

### 自动保存
- ✅ 自动保存所有地图标签页的状态
- ✅ 保存每个标签页的图层、视图、属性表状态
- ✅ 保存UI布局状态
- ✅ 防抖机制（1秒延迟），避免频繁保存

### 启动恢复
- ✅ 应用启动时自动恢复上次的会话
- ✅ 恢复所有地图标签页和图层
- ✅ 过滤不存在的文件，避免加载错误
- ✅ 恢复地图中心点、缩放级别
- ✅ 恢复图层的符号系统和标注配置
- ✅ 恢复属性表打开状态

### 保存内容
每个地图标签页保存：
- 地图名称、中心点、缩放级别
- 所有图层的完整配置（路径、样式、可见性等）
- 图层分组结构
- 选中的图层
- 打开的属性表

全局保存：
- 激活的标签页ID
- UI面板的展开/折叠状态
- 面板的停靠位置和尺寸

## 后续优化建议

1. **标签页复制**：快速复制现有地图标签页
2. **标签页快捷键**：支持 Ctrl+Tab 等快捷键切换标签页
3. **地图对比模式**：支持同时显示多个地图进行对比
4. **导出/导入会话**：支持会话文件的导入导出

## 测试要点

### 基础功能测试
1. 创建多个地图标签页
2. 在不同标签页中添加不同的图层
3. 切换标签页，验证图层面板内容正确更新
4. 验证每个标签页的地图视图状态独立
5. 测试标签页的重命名和关闭功能
6. 验证至少保留一个标签页的限制
7. 测试标签页的拖拽排序功能

### 持久化功能测试
1. 创建多个标签页并添加图层
2. 调整地图视图（中心点、缩放）
3. 配置图层样式和标注
4. 打开属性表
5. 关闭应用
6. 重新打开应用，验证所有状态正确恢复
7. 验证文件不存在时的处理（自动过滤）

## 技术实现文件

| 文件 | 说明 |
|------|------|
| `src/services/storageService.ts` | 持久化服务，保存/加载会话状态 |
| `src/hooks/useRestoreSession.ts` | 会话恢复 Hook |
| `src/stores/mapTabsStore.ts` | 多地图标签页状态管理 |
| `src/components/Map/MapTabsContainer.tsx` | 标签页容器组件 |
| `src/App.tsx` | 自动保存逻辑 |

## 更新日期
2025-01-23
