# MiniGIS v0.5.0 发布说明 🎉

**发布日期**: 2025-10-24  
**版本类型**: Minor Release (新增功能)

---

## 📖 版本概述

v0.5.0 是一个重要的功能增强版本，带来了专业GIS软件级别的数据管理体验。本版本重点优化了数据导入流程，新增了多地图标签页系统，并修复了关键的会话恢复问题。

### 核心亮点

✨ **ArcGIS Pro 风格数据浏览器** - 重构添加数据对话框，提供专业的文件浏览和导航体验  
🗄️ **FileGeoDatabase 支持** - 完整支持 ESRI GDB 数据库格式  
📑 **多地图标签页系统** - 类似 ArcGIS Pro 的多地图管理能力  
🔍 **要素识别增强** - 支持多图层重叠要素的识别和树形导航  
🐛 **会话恢复修复** - 修复了影响用户体验的关键问题  
🎯 **坐标系统简化** - 统一使用 CGCS2000 国家标准坐标系

---

## ✨ 新增功能

### 1. 添加数据对话框重构

完整重构了数据导入界面，采用 ArcGIS Pro 风格的专业交互模式：

#### 核心特性
- **列表详细视图**: 表格显示文件名称、类型、几何类型、要素数量
- **左侧目录树**: 快速访问桌面、文档、下载等常用位置
- **实时搜索过滤**: 顶部工具栏快速定位文件
- **专业导航系统**: 
  - 后退/前进按钮：浏览历史记录
  - 向上一级：快速返回父目录
  - 面包屑导航：显示当前路径，可点击跳转
- **路径快速跳转**: 底部路径输入框，粘贴路径按 Enter 直接跳转
- **文件类型筛选**: 下拉菜单筛选所有类型、文件夹、GDB、Shapefile、GeoPackage、GeoJSON、KML/KMZ
- **快捷方式支持**: 识别 Windows 快捷方式(.lnk)，双击跳转到目标位置
- **专业多选逻辑**: 
  - 单击：选中当前项
  - Ctrl+单击：切换选中状态
  - Shift+单击：范围选择
- **会话内记忆**: 对话框关闭后再打开自动恢复上次位置

#### GDB 导航体验
- 双击进入 GDB 内部查看要素集和图层
- 双击要素集只显示该要素集的图层
- 退出 GDB 返回文件系统
- 路径格式：`path::dataset::layer` 支持层级导航

---

### 2. FileGeoDatabase (GDB) 数据库支持

新增对 ESRI FileGeoDatabase 的完整支持：

#### 核心特性
- **直接打开 `.gdb` 文件夹**: 自动识别数据库中的所有图层
- **要素集层级结构**: 支持 Feature Dataset 的组织方式
- **专业图层选择界面**: 
  - 按要素集分组显示图层
  - 独立要素类单独列出
  - 显示几何类型和要素数量
  - 支持多选批量加载
- **智能加载机制**: 
  - 异步加载避免 UI 阻塞
  - 自动坐标系转换
  - 加载进度提示

#### 访问方式
- 主页 → 添加数据 → 选择 GDB 文件夹
- 在添加数据对话框中双击 `.gdb` 进入浏览

#### 技术细节
- 使用 GDAL 多图层读取 API
- 图层名称解析识别要素集关系
- React Modal 组件实现选择界面

---

### 3. 多地图标签页系统

类似 ArcGIS Pro 的多地图标签页功能，支持同时管理多个独立地图：

#### 核心特性
- **多地图管理**: 
  - 每个标签页独立的地图视图、图层列表、选中状态
  - 标签页间完全隔离，互不影响
  - 至少保留一个标签页
- **丰富的标签页操作**: 
  - 新建：通过"插入"→"新建地图"或右上角"+"按钮
  - 重命名：右键菜单→"重命名"
  - 关闭：点击"×"或右键菜单→"关闭"
  - 拖拽排序：长按 200ms 拖动标签页调整顺序
- **独立图层管理**: 
  - 图层面板自动显示当前标签页的图层
  - 图层操作仅影响当前标签页
  - 支持图层分组、符号系统、标注配置
- **状态持久化**: 
  - 自动保存所有标签页状态（防抖 1 秒）
  - 保存：地图名称、视图状态、图层配置、属性表状态、UI布局
  - 启动时自动恢复上次会话
  - 智能过滤不存在的文件
  - 恢复时保持上次的缩放级别和位置

#### 技术实现
- Zustand 管理多地图标签页状态
- @dnd-kit 实现标签页拖拽排序
- localStorage 持久化会话数据
- 防抖机制避免频繁保存

---

### 4. 要素识别增强

浏览模式下的要素识别功能全面升级：

#### 核心特性
- **多图层要素识别**: 一次点击识别多个图层的要素
- **重叠要素显示**: 识别和显示同一位置的所有重叠要素
- **树形结构导航**: GIS 风格的树形选择器
  - 显示图层名称和要素数量（如 "道路图层 (3)"）
  - 显示要素 ID 和几何类型（如 "要素1 [Polygon]"）
  - 支持可折叠/展开图层节点
  - 点击要素节点自动切换显示属性
- **要素闪烁定位**: 切换要素时地图自动高亮闪烁定位
- **紧凑 UI 设计**: 优化面板布局，提升空间利用率

---

## 🐛 Bug 修复

### 会话恢复相关修复

#### 1. 会话被空标签页覆盖
- **问题**: 重新打开软件时无法恢复之前打开的图层和标签页
- **根本原因**: 应用启动时创建的空标签页在会话恢复前被自动保存，覆盖了之前的会话记录
- **解决方案**: `useRestoreSession` Hook 现在返回恢复完成状态，自动保存功能只在会话恢复完成后启用
- **影响**: 确保用户的工作会话被正确保存和恢复

#### 2. 恢复后图层不显示
- **问题**: 会话恢复后图层和底图不显示，需要手动开关图层才能加载
- **根本原因1**: 使用 `array.splice()` 直接修改数组不会触发 Zustand 订阅更新
- **根本原因2**: 图层加载循环中使用 `return` 退出整个函数，导致只加载第一个图层
- **解决方案**: 改用 `setState` 触发状态更新，将 `return` 改为 `continue`
- **影响**: 恢复后所有图层正常显示，无需手动操作

---

## 🔧 改进与优化

### 坐标系统简化

为简化系统复杂度，统一使用国家标准 CGCS2000 坐标系：

#### 变更内容
- **固定 CGCS2000 坐标系**: 系统默认使用 CGCS2000 地理坐标系（EPSG:4490）
- **移除坐标系设置**: 简化用户界面，移除坐标系选择功能
- **自动坐标转换**: 所有数据自动转换到 CGCS2000 底图坐标系显示
- **统一经纬度显示**: 状态栏固定显示经纬度格式

#### 影响范围
- 移除了 CRSPanel、CRSDialog、useCRSProjection 等组件
- 移除了 Ribbon 菜单中的"坐标系"按钮
- 简化了地图投影设置和坐标显示逻辑

---

## ⚠️ 破坏性变更

### 移除用户自定义坐标系功能

- **用户影响**: 用户不能再通过 UI 切换地图坐标系
- **原因**: 简化系统复杂度，统一使用国家标准 CGCS2000 坐标系
- **迁移指南**: 
  - 所有数据会自动转换到 CGCS2000 坐标系显示
  - 保存的会话不再恢复坐标系设置
  - 数据文件的原始坐标系会被自动识别并转换

---

## 📊 统计信息

- **新增功能**: 4 项
- **Bug 修复**: 2 项
- **改进优化**: 1 项
- **破坏性变更**: 1 项
- **新增文件**: 6 个
- **删除文件**: 3 个

---

## 🎯 升级指南

### 从 v0.4.0 升级

1. **下载安装**: 下载并安装 MSI 安装包
2. **自动迁移**: 首次启动会自动迁移旧版本的会话数据
3. **坐标系变更**: 如果之前使用自定义坐标系，升级后将统一使用 CGCS2000
4. **新功能体验**: 
   - 尝试使用新的添加数据对话框
   - 体验多地图标签页功能
   - 测试 GDB 数据库支持

### 兼容性说明

- **数据格式**: 完全兼容 v0.4.0 的所有数据格式
- **项目文件**: 会话数据格式有少量变更，但自动兼容
- **配置文件**: 会自动迁移旧的配置

---

## 🔗 相关文档

- [完整变更日志](../../CHANGELOG.md)
- [GDB 支持文档](../GDB_SUPPORT.md)
- [多地图标签页功能](../MAP_TABS_FEATURE.md)
- [会话恢复修复说明](../SESSION_RESTORE_FIX.md)
- [图层渲染修复说明](../LAYER_RENDER_FIX.md)

---

## 📦 下载

### Windows MSI 安装包

- **文件名**: `MiniGIS_0.5.0_x64_zh-CN.msi`
- **系统要求**: Windows 10/11 x64
- **无需预装**: 自动配置所有 GDAL 依赖

### 校验和

SHA256 校验和将在发布时提供。

---

## 💡 快速开始

1. 下载并安装 MSI 文件
2. 启动 MiniGIS
3. 主页 → 添加数据 → 浏览并选择 GIS 数据
4. 尝试创建多个地图标签页
5. 关闭软件后重新打开，体验会话恢复功能

---

## 🙏 致谢

感谢所有贡献者和用户的反馈，让 MiniGIS 不断完善！

---

**下一版本预告**: v0.6.0 将继续优化数据处理性能和用户体验。
