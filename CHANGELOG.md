# Changelog

本文档记录MiniGIS项目的所有重要更改。

## [0.4.0] - 2025-10-20

### ✨ 新增功能 - 矢量数据导出

- **📤 完整的数据导出功能** - 支持多种格式的矢量数据导出
  - **支持格式**:
    - KML - Google Earth格式
    - KMZ - 压缩的KML格式
    - GeoJSON - Web标准地理数据格式
    - Shapefile - GIS标准矢量格式
    - GeoPackage - 现代GIS数据容器格式
  - **功能特性**:
    - 完整保留所有字段值和几何信息
    - 使用ogr2ogr工具确保转换准确性
    - 友好的导出对话框和进度提示
    - 自动文件命名和保存路径选择
  - **访问方式**:
    - 图层右键菜单 → "导出数据"
    - 工具栏 → "导出工具"窗口
  - **技术实现**:
    - 使用GDAL ogr2ogr命令行工具进行格式转换
    - 智能查找ogr2ogr可执行文件（应用目录/PATH环境变量）
    - 开发环境和打包环境自动适配
  - **打包配置**:
    - build.rs自动复制28个GDAL工具到应用目录
    - resources配置确保工具文件夹被打包进MSI
    - 优化复制策略：debug模式只复制到target，release模式同时复制到src-tauri供打包
  - **修改文件**:
    - `ExportPanel.tsx` - 新增导出工具面板组件
    - `LayerPanel.tsx` - 图层右键菜单添加导出选项
    - `windowStore.ts` - 添加导出工具窗口配置
    - `gdal_service.rs` - 添加export_vector函数和ogr2ogr查找逻辑
    - `build.rs` - 添加GDAL工具自动复制逻辑
    - `tauri.conf.json` - 配置gdal-tools资源打包

### ✨ 新增功能 - KML/KMZ格式支持

- **🗺️ 完整支持KML/KMZ格式** - 新增Google Earth格式的矢量数据支持
  - **功能特性**:
    - 支持打开和显示KML/KMZ文件
    - 自动使用UTF-8编码读取，确保中文正常显示
    - 智能解析description字段中的属性数据
    - 将打包的属性自动拆分为独立字段
    - 完整支持中文字段名和值（如"岸别"、"县（区）"等）
  - **解析能力**:
    - 正则表达式解析键值对格式：`"key":value` 或 `"key":"value"`
    - 自动识别数据类型（字符串、整数、浮点数）
    - 支持中文字段和复杂属性结构
  - **影响范围**:
    - 属性表完整显示所有解析后的字段
    - 要素信息面板显示完整属性
    - 地图标注可使用解析后的字段
  - **修改文件**:
    - `gdal_service.rs` - 添加`parse_kml_description`解析函数
    - `gdal_service.rs` - 更新3个读取函数支持KML
    - `RibbonMenu.tsx` - 优化文件类型映射逻辑
    - `Cargo.toml` - 添加regex依赖
  - **技术实现**:
    - 智能检测文件类型（KML/KMZ使用UTF-8，Shapefile使用GBK）
    - 在`read_vector_features`、`read_vector_features_with_geometry`和`read_vector_as_geojson`三个函数中都添加解析
    - 使用正则表达式提取description中的所有属性
    - 自动合并解析结果到properties对象

### 🐛 Bug修复 - 闪退问题

- **🔥 修复数据解析时的闪退问题** - 彻底解决个别电脑添加数据时软件崩溃的严重bug
  - **根本原因1**: 坐标转换失败时使用`expect()`导致panic，无错误提示直接崩溃
  - **根本原因2**: WGS84坐标系创建失败时直接panic
  - **修复方案**: 将所有`expect()`改为安全的`map_err()`错误处理
  - **影响文件**: `gdal_service.rs` 的3处关键位置（第73、291、424行）
  - **影响**: 修复前任何坐标转换失败都会导致软件闪退，修复后返回友好错误信息

### 🐛 Bug修复 - Shapefile中文乱码

- **🔤 修复Shapefile中文属性乱码问题** - 彻底解决中文属性显示为乱码的问题
  - **根本原因**: Shapefile的DBF文件使用GBK编码，但GDAL默认按UTF-8解析
  - **问题表现**: 中文字段名和属性值显示为"ͼ����"、"��ʩũ�õ�"等乱码
  - **修复方案**: 
    - 实现智能编码检测机制，自动识别UTF-8和GBK编码
    - 支持`.cpg`编码声明文件，标准化编码管理
    - 设置全局默认编码为GBK（中国shapefile最常用）
    - 文件级别可覆盖全局设置，支持混合编码文件
  - **编码检测优先级**: `.cpg文件` > `GBK` > `UTF-8` > `系统默认`
  - **影响文件**: 
    - `gdal_service.rs` - 添加智能编码检测函数
    - `gdal_init.rs` - 设置全局GBK默认编码
  - **影响**: 修复前中文属性完全不可读，修复后自动适配各种编码格式

### ✨ 改进功能

- **🚀 GDAL环境自动配置优化** - 开发环境统一启动体验
  - `npm run tauri:dev` 可直接启动，无需额外脚本
  - 智能环境检测：自动识别开发模式（vcpkg）和打包模式（应用目录）
  - PATH环境变量自动配置：同时支持vcpkg和应用目录
  - GDAL_DATA和PROJ_LIB自动检测和设置
  - 开发和打包环境使用统一的启动逻辑
  - debug模式也自动复制GDAL文件到target/debug
  - 详细的日志输出，方便问题排查

- **📊 增强GDAL初始化日志** - 详细的启动日志帮助诊断问题
  - 清晰的环境变量设置日志（GDAL_DATA、PROJ_LIB）
  - DLL加载路径验证日志
  - proj.db文件存在性检查
  - GDAL驱动数量统计
  - 使用✓/✗/⚠符号标记状态，方便快速识别问题

- **🔍 增强健康检查功能** - 更全面的GDAL环境诊断
  - 详细的驱动列表输出
  - 关键环境变量验证
  - 数据文件完整性检查
  - 更友好的错误提示信息

### 🛠️ 开发工具

- **新增自动诊断脚本** - `scripts/diagnose_crash.ps1`
  - 自动检查安装完整性
  - 验证PROJ/GDAL数据文件
  - 检查DLL依赖
  - 验证MSVC运行时
  - 生成详细诊断报告

- **新增故障排查文档** - `docs/CRASH_TROUBLESHOOTING.md`
  - 完整的问题诊断流程
  - 根本原因分析
  - 多种解决方案
  - 高级调试技巧
  - 预防措施说明

### 🎯 技术改进

- **安全性**: 移除所有可能导致panic的unsafe代码
- **容错性**: 增强错误处理机制，确保所有错误都能被优雅处理
- **可维护性**: 详细的日志便于问题定位和修复
- **用户体验**: 提供友好的错误信息而非直接崩溃

---

## [0.3.0] - 2025-10-16

### ✨ 新增功能

#### 会话恢复增强
- ✅ **完整状态保存** - 保存所有应用状态信息
  - 地图位置和缩放级别（不受"缩放到图层"影响）
  - 当前坐标系配置（EPSG代码、WKT定义）
  - 底图配置（用户选择的底图及其可见性）
  - 图层完整状态（可见性、透明度、样式、符号、标注）
  - UI布局状态（面板折叠、尺寸、位置）
  - 属性表打开状态（打开的图层、激活的标签页）

- ✅ **智能自动保存** - 多重触发机制
  - 图层变化后自动保存（2秒延迟）
  - 地图移动后自动保存（1秒延迟）
  - 坐标系切换后自动保存（0.1秒延迟）
  - UI状态变化后自动保存（1秒延迟）

- ✅ **完整恢复流程**
  - 启动时自动恢复上次会话（1秒延迟）
  - 验证文件存在性，自动跳过不存在的文件
  - 恢复底图配置（移除默认底图，使用保存的配置）
  - 恢复属性表状态（延迟0.5秒确保图层加载完成）
  - 容错处理，单个图层失败不影响其他恢复

### 🐛 Bug修复
- **🔥 会话恢复未生效** - 修复坐标系、底图、UI状态等完全不恢复的严重问题
  - **根本原因**：App.tsx 中有旧的恢复代码，新的 `useRestoreSession` hook 没有被调用
  - 旧代码只恢复了地图位置和部分图层，缺少坐标系、底图、UI状态等恢复
  - 移除旧代码，改用新的 `useRestoreSession` hook
  - 添加详细的控制台日志追踪恢复过程
  - **影响**：修复前，用户设置的坐标系、底图配置、面板布局等完全不会被记住

- **底图记忆问题** - 修复底图每次都恢复为默认星图的问题
  - layerStore 初始化时检查是否有保存的会话
  - 有会话时不添加默认底图，由恢复逻辑处理
  - 无保存底图时自动添加默认底图
  - 确保用户自定义的底图配置被正确保存和恢复

- **循环依赖警告** - 修复控制台循环依赖警告
  - 使用全局对象注册 store 避免循环依赖
  - 添加完善的空值检查和默认值处理
  - 导出必要的类型接口供其他模块使用

### 📖 文档更新
- 新增 `docs/SESSION_RESTORE.md` - 会话恢复功能详细文档
  - 保存的状态信息说明
  - 自动保存机制详解
  - 恢复流程和容错处理
  - 开发者扩展指南

---

## [0.2.0] - 2025-10-14

### 🎉 重大更新

#### 核心功能
- ✅ **GDAL完整集成** - 支持Shapefile、GeoJSON、GeoPackage等多种矢量格式
- ✅ **坐标系统** - 自动坐标转换到WGS84，支持EPSG和投影坐标系
- ✅ **OpenLayers引擎** - 企业级开源地图库，功能强大，性能优异
- ✅ **MSI安装包** - 企业级Windows安装程序，包含所有运行时依赖

#### 用户界面
- ✅ **启动加载页面** - 优雅的应用启动体验
- ✅ **符号系统** - 完整的点、线、面符号自定义编辑器
- ✅ **测量工具** - 距离、面积测量功能
- ✅ **图层面板增强** - 拖拽排序、可见性控制

#### 技术改进
- ✅ **GDAL数据打包** - 自动打包所有GDAL和PROJ数据文件
- ✅ **DLL依赖管理** - 自动复制50+个运行时依赖库
- ✅ **WKT坐标系** - 使用WKT替代EPSG，避免数据库依赖问题
- ✅ **CSP安全策略** - 修复Web Worker支持，确保地图正常渲染
- ✅ **错误诊断** - GDAL诊断命令，方便排查问题

#### Bug修复
- 🐛 修复打包后无法打开shp文件的问题
- 🐛 修复PROJ数据库读取错误
- 🐛 修复地图图形不渲染的CSP问题
- 🐛 修复测量工具图形不显示
- 🐛 修复坐标转换失败导致范围超限

### 📦 打包配置
- MSI安装包包含完整GDAL运行时
- 自动配置环境变量（GDAL_DATA, PROJ_LIB）
- 中文界面支持

### 🛠️ 开发改进
- 添加`npm run dev:gdal`脚本，自动配置GDAL环境
- 改进build.rs，自动复制所有依赖
- 完善.gitignore，忽略构建产物

---

## [0.1.0] - 初始版本

### 核心功能
- ✅ Shapefile基础支持
- ✅ Ribbon UI框架
- ✅ 图层管理面板
- ✅ 属性表查看
- ✅ 项目保存/加载
- ✅ Google卫星底图

### 技术栈
- React 18 + TypeScript
- Tauri 2.0
- Leaflet地图引擎
- Ant Design 5
- Zustand状态管理

---

## 版本说明

- **Major (x.0.0)**: 重大架构变更或不兼容的API修改
- **Minor (0.x.0)**: 新功能添加，向后兼容
- **Patch (0.0.x)**: Bug修复和小改进

[0.4.0]: https://github.com/xiaofuX1/MiniGIS/releases/tag/v0.4.0
[0.3.0]: https://github.com/xiaofuX1/MiniGIS/releases/tag/v0.3.0
[0.2.0]: https://github.com/xiaofuX1/MiniGIS/releases/tag/v0.2.0
[0.1.0]: https://github.com/xiaofuX1/MiniGIS/releases/tag/v0.1.0
